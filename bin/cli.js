#!/usr/bin/env node

"use strict";function _interopDefault(a){return a&&"object"==typeof a&&"default"in a?a["default"]:a}var fs=_interopDefault(require("fs-extra")),path=_interopDefault(require("path")),sharp=_interopDefault(require("sharp")),glob=_interopDefault(require("glob")),yargs=_interopDefault(require("yargs-parser"));function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}function _toConsumableArray(a){return _arrayWithoutHoles(a)||_iterableToArray(a)||_nonIterableSpread()}function _arrayWithoutHoles(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}}function _iterableToArray(a){if(Symbol.iterator in Object(a)||"[object Arguments]"===Object.prototype.toString.call(a))return Array.from(a)}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}var Settings=function a(b,c){var d=Math.max,e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:20,f=3<arguments.length&&void 0!==arguments[3]?arguments[3]:20,g=4<arguments.length?arguments[4]:void 0,h=5<arguments.length?arguments[5]:void 0;_classCallCheck(this,a),this.input=b,this.output=c,this.stdDeviationX=d(e,0),this.stdDeviationY=d(f,0),this.width=g===void 0&&h===void 0?40:g,this.height=h,this.format=null,this.originalWidth=0,this.originalHeight=0};function resize(a){var b=sharp(a.input);return b.metadata().then(function(c){return a.format=c.format,a.originalWidth=c.width,a.originalHeight=c.height,b.resize(a.width,a.height).toBuffer({resolveWithObject:!0})})}function embed(a,b,c){var d=Math.round,e="data:image/"+c.format+";base64,"+a.toString("base64"),f=void 0===c.width&&void 0!==c.height?d(c.originalHeight/b.height):d(c.originalWidth/b.width),g=f*b.width,i=f*b.height,j=c.originalWidth,k=c.originalHeight,h=c.stdDeviationX,l=c.stdDeviationY;return Buffer.from("<svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" width=\""+j+"\" height=\""+k+"\" viewBox=\"0 0 "+g+" "+i+"\" preserveAspectRatio=\"none\"><filter id=\"blur\" filterUnits=\"userSpaceOnUse\" color-interpolation-filters=\"sRGB\"><feGaussianBlur stdDeviation=\""+h+" "+l+"\" edgeMode=\"duplicate\"/><feComponentTransfer><feFuncA type=\"discrete\" tableValues=\"1 1\" /></feComponentTransfer></filter><image filter=\"url(#blur)\" x=\"0\" y=\"0\" height=\"100%\" width=\"100%\" xlink:href=\""+e+"\"/></svg>")}function writeFile(a,b){var c=b.output;return""===path.extname(c)&&(c=path.join(c,path.basename(b.input,path.extname(b.input)))+".svg"),fs.outputFile(c,a)}var BlurUp=function(){function a(){_classCallCheck(this,a)}return _createClass(a,null,[{key:"generate",value:function(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},d=new Settings(a,b,c.stdDeviationX,c.stdDeviationY,c.width,c.height);return resize(d).then(function(a){var b=a.data,c=a.info;return embed(b,c,d)}).then(function(a){return writeFile(a,d)})}}]),a}(),argv=Object.assign({config:null,input:null,output:null},yargs(process.argv.slice(2),{alias:{config:["c"],input:["i"],output:["o"]}}));function generate(a,b){return new Promise(function(d){var e=b.length,f=0,g=e;(function c(){if(f===e)d("Generated "+g+" SVG "+(1===g?"file":"files"));else{var h=b[f++];BlurUp.generate(h,a.output,a).then(c).catch(function(a){--g,console.warn(a.message,"("+h+")"),c()})}})()})}function getFiles(a){return new Promise(function(b,c){var d=a.input,e=[],f=0;(function g(h,i){null===h?(e=e.concat(i),f===d.length?0===e.length?c("No input files found"):b([a,e]):glob(d[f++],g)):c(h)})(null,[])})}function validateConfig(){var a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{};return new Promise(function(b,c){null!==argv.input&&(a.input=argv.input),null!==argv.output&&(a.output=argv.output),a.input===void 0?c("No input path specified"):a.output===void 0?c("No output path specified"):""===path.extname(a.output)?(!Array.isArray(a.input)&&(a.input=[a.input]),b(a)):c("The output path must describe a directory")})}function readConfig(){var a=new Promise(function(a,b){fs.readFile(path.join(process.cwd(),"package.json")).then(function(c){try{a(JSON.parse(c).blurUp)}catch(a){b(a)}}).catch(function(){a()})}),b=new Promise(function(a,b){var c=path.join(process.cwd(),null===argv.config?".blur-up.json":argv.config);fs.readFile(c).then(function(c){try{a(JSON.parse(c))}catch(a){b(a)}}).catch(function(d){null===argv.config?a():"ENOENT"===d.code?b("Could not find the configuration file ("+c+")"):b("Failed to read the configuration file ("+d+")")})});return new Promise(function(c,d){a.then(function(a){return a===void 0?b:Promise.resolve(a)}).then(c).catch(d)})}readConfig().then(validateConfig).then(getFiles).then(function(a){return generate.apply(void 0,_toConsumableArray(a))}).then(console.log).catch(console.error);
