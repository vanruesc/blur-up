#!/usr/bin/env node

'use strict';function _interopDefault(a){return a&&'object'==typeof a&&'default'in a?a['default']:a}var fs=_interopDefault(require('fs-extra')),path=_interopDefault(require('path')),sharp=_interopDefault(require('sharp')),glob=_interopDefault(require('glob')),yargs=_interopDefault(require('yargs-parser')),classCallCheck=function(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')},createClass=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,'value'in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),toConsumableArray=function(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)},Settings=function a(b,c){var d=Math.max,e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:20,f=3<arguments.length&&void 0!==arguments[3]?arguments[3]:20,g=arguments[4],h=arguments[5];classCallCheck(this,a),this.input=b,this.output=c,this.stdDeviationX=d(e,0),this.stdDeviationY=d(f,0),this.width=g===void 0&&h===void 0?40:g,this.height=h,this.aspect=g!==void 0&&h!==void 0?g/d(h,1):0,this.format=null,this.originalWidth=0,this.originalHeight=0};function resize(a){var b=sharp(a.input);return b.metadata().then(function(c){return a.format=c.format,a.originalWidth=c.width,a.originalHeight=c.height,b.resize(a.width,a.height).toBuffer()})}function embed(a,b){var c='data:image/'+b.format+';base64,'+a.toString('base64'),d=b.originalWidth,e=0<b.aspect?Math.round(b.originalWidth/b.aspect):b.originalHeight,f=b.stdDeviationX,g=b.stdDeviationY;return Buffer.from('<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="'+d+'" height="'+e+'" viewBox="0 0 '+d+' '+e+'"><filter id="blur" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB"><feGaussianBlur stdDeviation="'+f+' '+g+'" edgeMode="duplicate"/><feComponentTransfer><feFuncA type="discrete" tableValues="1 1" /></feComponentTransfer></filter><image filter="url(#blur)" x="0" y="0" height="100%" width="100%" xlink:href="'+c+'"/></svg>')}function writeFile(a,b){var c=b.output;return''===path.extname(c)&&(c=path.join(c,path.basename(b.input,path.extname(b.input)))+'.svg'),fs.outputFile(c,a)}var BlurUp=function(){function a(){classCallCheck(this,a)}return createClass(a,null,[{key:'generate',value:function(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},d=new Settings(a,b,c.stdDeviationX,c.stdDeviationY,c.width,c.height);return resize(d).then(function(a){return embed(a,d)}).then(function(a){return writeFile(a,d)})}}]),a}(),argv=Object.assign({config:'.blur-up.json',input:null,output:null},yargs(process.argv.slice(2),{alias:{config:['c'],input:['i'],output:['o']}}));function generate(a,b){return new Promise(function(c,d){var e=0;(function f(){e===b.length?c('Generated '+b.length+' SVG '+(1===b.length?'file':'files')):BlurUp.generate(b[e++],a.output,a).then(f).catch(d)})()})}function getFiles(a){return new Promise(function(b,c){var d=a.input,e=0;(function f(g,h){g!==void 0&&null!==g?c(g):e===d.length?b([a,h]):glob(d[e++],f)})()})}function verifyConfig(a){return new Promise(function(b,c){null!==argv.input&&(a.input=argv.input),null!==argv.output&&(a.output=argv.output),a.input===void 0?c('No input path specified'):a.output===void 0?c('No output path specified'):''===path.extname(a.output)?(!Array.isArray(a.input)&&(a.input=[a.input]),b(a)):c('The output path must describe a directory')})}function readConfig(){return new Promise(function(a,b){fs.readFile(path.join(process.cwd(),'package.json'),function(c,d){var e;if(null===c)try{e=JSON.parse(d).blurUp}catch(a){b(a)}e===void 0?fs.readFile(path.join(process.cwd(),argv.config),function(c,d){if(null!==c)'ENOENT'===c.code?b('No configuration found'):b('Failed to read the configuration file ('+c.code+')');else try{a(JSON.parse(d))}catch(a){b(a)}}):a(e)})})}readConfig().then(verifyConfig).then(getFiles).then(function(a){return generate.apply(void 0,toConsumableArray(a))}).then(console.log).catch(console.error);
